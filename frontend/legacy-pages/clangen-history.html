<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://eu.i.posthog.com https://cdn.jsdelivr.net https://eu-assets.i.posthog.com; img-src 'self' https://media.githubusercontent.com data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
    <title>ClanGen History Explorer - Interactive Timeline & Family Trees</title>
    <link rel="icon" type="image/png" href="../assets/images/beasty-favicon-rounded.png">
    <link rel="stylesheet" href="../assets/styles/pages/clangen-history.css">
</head>
<body>
    <!-- Floating back button -->
    <a class="back-btn" href="../index.html">‚Üê Back</a>
    
    <!-- View toggle controls -->
    <div class="view-controls" style="display: none;">
        <button id="switchClanBtn" class="control-button">Switch Clan</button>
        <button id="viewToggle" class="view-toggle">
            <span class="view-option active" data-view="timeline">Timeline</span>
            <span class="view-option" data-view="events">Events</span>
            <span class="view-option" data-view="family">Family Tree</span>
            <span class="view-option" data-view="cats">Cats</span>
        </button>
    </div>

    <!-- Background elements -->
    <div class="bg"></div>
    <div class="blob blob-a"></div>
    <div class="blob blob-b"></div>
    <div class="blob blob-c"></div>

    <!-- Main container -->
    <div class="container">
        <!-- File Upload Section -->
        <div id="uploadSection" class="upload-section">
            <div class="upload-card">
                <div class="upload-icon">üìÅ</div>
                <h2>Load Your ClanGen Save</h2>
                <p>Select your ClanGen saves folder to explore your clan's history</p>
                <div class="upload-options">
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none">
                    <button id="selectFolderBtn" class="primary-button">
                        Select Saves Folder
                    </button>
                    <div class="divider">or</div>
                    <div id="dropZone" class="drop-zone">
                        <p>Drag and drop your saves folder here</p>
                    </div>
                </div>
                <div class="example-path">
                    <small>Example: C:\Users\YourName\AppData\Local\ClanGen\ClanGen\saves</small>
                </div>
                
                <!-- Direct path input for development (commented out) -->
                <!--
                <div style="margin-top: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                    <p style="font-size: 12px; color: var(--accent); margin-bottom: 8px;">Developer Mode: Direct Path Load</p>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="directPathInput" placeholder="/path/to/saves/folder" 
                               value="/home/beasty/projects/spinner-wheel/clangen/lifegen-saves"
                               style="flex: 1; padding: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
                        <button id="loadPathBtn" style="padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 14px;">
                            Load Path
                        </button>
                    </div>
                    <p style="font-size: 11px; color: var(--muted); margin-top: 5px;">
                        Example: /home/beasty/projects/spinner-wheel/clangen/lifegen-saves
                    </p>
                </div>
                -->
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <button id="clearDatabaseBtn" style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px;">
                        Clear Saved Data
                    </button>
                    <p style="margin-top: 10px; font-size: 11px; color: var(--muted);">
                        If data appears incorrect, clear and re-upload your saves folder
                    </p>
                </div>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="loading-section" style="display: none;">
            <div class="loading-card">
                <img src="../assets/images/paw.png" alt="Loading" class="paw-spinner large">
                <h2>Processing Clan Data...</h2>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <p id="progressText">Parsing save files...</p>
            </div>
        </div>

        <!-- Clan Selector (if multiple clans) -->
        <div id="clanSelector" class="clan-selector" style="display: none;">
            <div class="selector-card">
                <h2>Select a Clan to Explore</h2>
                <div id="clanList" class="clan-list">
                    <!-- Clan options will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="main-app" style="display: none;">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Clan Age:</span>
                    <span id="clanAge" class="stat-value">0 moons</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Cats:</span>
                    <span id="totalCats" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Living Cats:</span>
                    <span id="livingCats" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Events:</span>
                    <span id="totalEvents" class="stat-value">0</span>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Sidebar Filters -->
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <h3>Search</h3>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search cats or events...">
                    </div>

                    <!-- Moon Range removed - events don't have moon data, they're just chronological -->

                    <div class="sidebar-section">
                        <h3>Event Types</h3>
                        <div class="filter-group">
                            <label class="filter-option">
                                <input type="checkbox" value="birth" checked>
                                <span>Births</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="death" checked>
                                <span>Deaths</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="ceremony" checked>
                                <span>Ceremonies</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="relationship" checked>
                                <span>Relationships</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="health" checked>
                                <span>Health</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="misc" checked>
                                <span>Other</span>
                            </label>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h3>Density</h3>
                        <select id="densitySelect" class="density-select">
                            <option value="all" selected>Show All</option>
                            <option value="important">Important Only</option>
                            <option value="major">Major Events</option>
                        </select>
                    </div>

                    <button id="resetFilters" class="reset-button">Reset Filters</button>
                </aside>

                <!-- Main View Area -->
                <main class="main-view">
                    <!-- Timeline View -->
                    <div id="timelineView" class="view-panel timeline-view">
                        <div id="timelineContainer" class="timeline-container">
                            <!-- Timeline events will be rendered here -->
                        </div>
                    </div>

                    <!-- Family Tree View -->
                    <div id="familyView" class="view-panel family-view" style="display: none;">
                        <div class="tree-controls">
                            <button id="zoomIn" class="zoom-button">+</button>
                            <button id="zoomOut" class="zoom-button">‚àí</button>
                            <button id="resetZoom" class="zoom-button">‚ü≤</button>
                        </div>
                        <svg id="familyTree" class="family-tree"></svg>
                    </div>

                    <!-- Cats Grid View -->
                    <div id="catsView" class="view-panel cats-view" style="display: none;">
                        <div class="cats-controls">
                            <select id="catSort" class="cat-sort">
                                <option value="name">Sort by Name</option>
                                <option value="age">Sort by Age</option>
                                <option value="birth">Sort by Birth</option>
                                <option value="rank">Sort by Rank</option>
                            </select>
                            <label class="filter-option">
                                <input type="checkbox" id="showDeadCats">
                                <span>Show Dead Cats</span>
                            </label>
                        </div>
                        <div id="catsGrid" class="cats-grid">
                            <!-- Cat cards will be rendered here -->
                        </div>
                    </div>

                    <!-- Events View -->
                    <div id="eventsView" class="view-panel events-view" style="display: none;">
                        <div class="events-header">
                            <div class="events-note">
                                <span class="note-icon">‚ÑπÔ∏è</span>
                                <span>These events from events.json don't have moon timestamps. They show relationships, interactions, and miscellaneous clan events in chronological order.</span>
                            </div>
                        </div>
                        <div id="eventsContainer" class="events-container">
                            <!-- Events will be rendered here -->
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Cat Profile Modal -->
        <div id="catModal" class="modal" style="display: none;">
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <div class="cat-profile">
                    <div class="profile-header">
                        <canvas id="modalCatSprite" width="200" height="200"></canvas>
                        <div class="profile-info">
                            <h2 id="modalCatName">Cat Name</h2>
                            <div id="modalCatDetails">
                                <!-- Cat details will be inserted here -->
                            </div>
                        </div>
                    </div>
                    <div class="profile-tabs">
                        <button class="tab-button active" data-tab="timeline">Timeline</button>
                        <button class="tab-button" data-tab="relationships">Relationships</button>
                        <button class="tab-button" data-tab="sprites">All Sprites</button>
                    </div>
                    <div class="profile-content">
                        <div id="catTimeline" class="tab-content">
                            <!-- Cat's personal timeline -->
                        </div>
                        <div id="catRelationships" class="tab-content" style="display: none;">
                            <!-- Cat's relationships -->
                        </div>
                        <div id="catSprites" class="tab-content" style="display: none;">
                            <!-- All sprite variations -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script type="module" src="../js/posthog-init.js"></script>
    <script type="module" src="../js/pages/clangen-history.js"></script>
</body>
</html>
