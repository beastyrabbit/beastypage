<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <!-- Keep CSP aligned with other pages (no external CDNs) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://eu.i.posthog.com https://cdn.jsdelivr.net https://eu-assets.i.posthog.com; img-src 'self' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';" />
    <title>Cute Horror Collection – Gallery</title>
    <link rel="icon" type="image/png" href="../assets/images/beasty-favicon-rounded.png" />
    <style>
      :root {
        --bg: #040507;
        --panel: rgba(19, 22, 30, 0.92);
        --panel-soft: rgba(28, 32, 42, 0.7);
        --border: rgba(116, 107, 230, 0.3);
        --border-strong: rgba(158, 146, 255, 0.4);
        --text: #f6f6fa;
        --muted: #b9bed6;
        --accent: #a06bff;
        --radius-lg: 18px;
        --radius-md: 14px;
        --radius-sm: 12px;
        --shadow-md: 0 20px 56px rgba(6, 8, 20, 0.65);
        --shadow-xl: 0 36px 110px rgba(0, 0, 0, 0.82);
        --container-w: 1280px;
      }

      *, *::before, *::after { box-sizing: border-box; }
      html, body { margin: 0; padding: 0; }
      body {
        min-height: 100vh;
        background:
          radial-gradient(1200px 1200px at 18% 10%, rgba(145, 70, 255, 0.18), transparent 60%),
          radial-gradient(900px 900px at 82% 20%, rgba(96, 165, 250, 0.12), transparent 55%),
          radial-gradient(700px 700px at 46% 92%, rgba(88, 28, 135, 0.18), transparent 60%),
          var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        overflow-x: hidden;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        background: linear-gradient(145deg, rgba(20, 26, 48, 0.76), rgba(17, 21, 40, 0.64));
        border-bottom: 1px solid var(--border);
      }
      .nav {
        margin: 0 auto;
        max-width: var(--container-w);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .nav a { color: var(--text); text-decoration: none; }
      .nav .crumb { color: var(--muted); }

      main { padding: 24px 16px 48px; }
      .container { width: 100%; max-width: var(--container-w); margin: 0 auto; }

      .hero {
        display: grid; gap: 10px; text-align: center; justify-items: center; margin-bottom: 18px;
      }
      .hero h1 { margin: 0; font-size: clamp(2rem, 3.3vw, 2.8rem); background: linear-gradient(50deg, #c084fc, #60a5fa); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
      .hero p { margin: 0; color: var(--muted); }

      .info-triggers {
        margin-top: 18px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .info-trigger {
        padding: 10px 18px;
        border-radius: 999px;
        background: linear-gradient(135deg, rgba(95, 86, 210, 0.8), rgba(141, 123, 248, 0.85));
        border: 1px solid rgba(158, 146, 255, 0.4);
        color: var(--text);
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: 0.02em;
        cursor: pointer;
        transition: transform 160ms ease, box-shadow 160ms ease;
      }
      .info-trigger:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
      }
      .info-trigger:focus-visible {
        outline: 2px solid rgba(158, 146, 255, 0.7);
        outline-offset: 3px;
      }

      .info-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(4, 5, 7, 0.82);
        z-index: 120;
        padding: 24px;
      }
      .info-modal.open { display: flex; }
      .info-modal__card {
        max-width: min(720px, calc(100vw - 48px));
        max-height: calc(100vh - 96px);
        overflow-y: auto;
        padding: 28px 32px;
        border-radius: 18px;
        background: linear-gradient(145deg, rgba(18, 22, 32, 0.95), rgba(12, 15, 24, 0.9));
        border: 1px solid rgba(158, 146, 255, 0.28);
        box-shadow: 0 36px 110px rgba(0, 0, 0, 0.78);
        display: grid;
        gap: 16px;
      }
      .info-modal__card h2 {
        margin: 0;
        font-size: 1.6rem;
        color: var(--text);
      }
      .info-modal__card h3 {
        margin: 18px 0 8px;
        font-size: 1.1rem;
        color: var(--text);
      }
      .info-modal__card p {
        margin: 0;
        color: var(--muted);
        line-height: 1.65;
      }
      .info-modal__close {
        justify-self: end;
        padding: 6px 12px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: var(--text);
        cursor: pointer;
      }
      .info-modal__close:hover {
        background: rgba(255, 255, 255, 0.16);
      }

      /* Gallery wrapper */
      .gallery-wrap {
        position: relative;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        background: linear-gradient(145deg, rgba(20, 26, 48, 0.94), rgba(17, 21, 40, 0.78));
        box-shadow: var(--shadow-md);
        padding: 12px;
      }
      /* The justified grid is rendered as rows of anchors with explicit sizes */
      .gallery {
        position: relative;
      }
      .gallery-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .gallery-row:last-child { margin-bottom: 0; }
      .gallery a.thumb {
        display: block;
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        background: #0f1330;
        border: 1px solid rgba(255,255,255,0.08);
      }
      .gallery a.thumb img {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
        transition: filter 220ms ease, transform 220ms ease, opacity 220ms ease;
      }
      .gallery a.thumb img.is-blur {
        filter: blur(18px);
        transform: scale(1.05);
      }
      .gallery a.thumb img.is-sharp {
        filter: none;
        transform: scale(1);
        opacity: 1;
      }

      /* Lightbox */
      .lightbox {
        position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
        background: rgba(3, 6, 20, 0.82);
        z-index: 100;
      }
      .lightbox.open { display: flex; }
      .lightbox__inner {
        position: relative;
        max-width: min(1320px, calc(100vw - 48px));
        width: min(1320px, calc(100vw - 48px));
        max-height: calc(100vh - 48px);
        display: grid;
        justify-items: center;
      }
      .lightbox__frame {
        position: relative;
        width: 100%;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 32px 90px rgba(0, 0, 0, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(145deg, rgba(13, 18, 32, 0.96), rgba(18, 24, 44, 0.82));
      }
      .lightbox__img {
        display: block;
        width: 100%;
        height: 70vh;
        max-height: 70vh;
        object-fit: contain;
        background: radial-gradient(circle at center, rgba(255,255,255,0.05), rgba(9,12,28,0.9));
      }
      .lightbox__caption {
        position: absolute;
        left: 20px;
        right: 20px;
        bottom: 20px;
        padding: 14px 18px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(20, 24, 44, 0.82), rgba(12, 16, 28, 0.72));
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        border: 1px solid rgba(255, 255, 255, 0.14);
        box-shadow: 0 16px 36px rgba(5, 7, 18, 0.6);
        display: grid;
        gap: 4px;
        justify-items: center;
        color: var(--muted);
        text-align: center;
      }
      .lightbox__title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text);
        text-shadow: 0 0 24px rgba(96, 165, 250, 0.35);
      }
      .lightbox__meta {
        font-size: 0.96rem;
        color: rgba(199, 202, 229, 0.9);
      }
      .lightbox__meta a {
        color: #9ad0ff;
        text-decoration: underline;
      }
      .lightbox__close {
        position: absolute; top: 16px; right: 16px;
        background: rgba(255,255,255,0.1); color: var(--text);
        border: 1px solid rgba(255,255,255,0.18);
        border-radius: 10px; padding: 8px 12px; cursor: pointer;
      }

      @media (max-width: 768px) {
        .nav { padding: 10px 12px; }
        .gallery-row { gap: 6px; margin-bottom: 6px; }
        .gallery-wrap { padding: 10px; }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="nav" aria-label="Breadcrumb">
        <a href="../stream.html">← Back to Hub</a>
        <span class="crumb" aria-hidden="true">/</span>
        <strong>Cute Horror Collection</strong>
      </nav>
    </header>

    <main>
      <div class="container">
        <section class="hero" aria-labelledby="title">
          <h1 id="title">Cute Horror Collection</h1>
          <div class="info-triggers">
            <button class="info-trigger" data-modal-trigger="concept-modal">Concept Overview</button>
            <button class="info-trigger" data-modal-trigger="pitch-modal">Artist Pitch</button>
          </div>
        </section>

        <div id="concept-modal" class="info-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="concept-modal-title">
          <div class="info-modal__card">
            <button type="button" class="info-modal__close" data-modal-close>Close</button>
            <h2 id="concept-modal-title">The Beasty Collection Concept</h2>
            <p>This is the note I shared with collaborators when I kicked off the collection. It explains the Cute Horror mood and how each artist could bend it.</p>
            <h3>The Spark</h3>
            <p>The very first commission captured the perfect mix of adorable and sinister. It instantly made me wonder what a whole squad of these fluffy terrors could look like—Beastychicken, Beastyrabbit, Beastyrat, and beyond.</p>
            <h3>Why Cute Horror?</h3>
            <p>I love the contrast where sweet silhouettes hide sharp teeth. Manga, games, and little mascots with deadly secrets are the core inspiration for the project.</p>
            <h3>Creative Freedom</h3>
            <p>Every artist gets to interpret the theme however they like: color palettes, species, props, even lore are completely open. The only constant is that playful push and pull between charm and danger.</p>
            <h3>Looking Ahead</h3>
            <p>Ultimately this collection is about giving artists space to show their perspective. I hope each finished piece feels like a peek into their imagination, shaped by the freedom they were given.</p>
          </div>
        </div>
        <div id="pitch-modal" class="info-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pitch-modal-title">
          <div class="info-modal__card">
            <button type="button" class="info-modal__close" data-modal-close>Close</button>
            <h2 id="pitch-modal-title">Artist Pitch (Historical, Not Active)</h2>
            <p>This is the brief I sent to artists when inviting them to contribute. It explains the vibe, sizes, and what I hoped to collect.</p>
            <h3>Theme &amp; Mood</h3>
            <p>Cute &amp; Horror or Evil or Zombie—anything charming that hides a darker edge.</p>
            <h3>Goal</h3>
            <p>I wanted each artist to feel totally free, so the collection could explore different styles while staying recognizably Cute and Horror. The pitch emphasised that they could choose any species, props, or cinematic moment.</p>
            <h3>Size Guidelines</h3>
            <p>Poster scale (around 120×90 cm / 47.2×35.4 in) was the north star, but I also accepted A3 (29.7×42 cm) for digital pieces.</p>
            <h3>Collaboration Hub</h3>
            <p>The Discord server doubled as a WIP lounge and inspiration board so new artists could plug in quickly and stay synced with others.</p>
            <h3>Current Status</h3>
            <p>The project is on hold after reaching 50 commissions.</p>
            <p>Chasing late updates and getting ghosted made the final stretch feel like work instead of fun.</p>
            <p>If you still want to follow along, keep an eye on my stream Discord (quiet but alive) or socials on Bluesky and X/Twitter.</p>
          </div>
        </div>
        <section class="gallery-wrap" aria-label="Gallery">
          <div id="gallery" class="gallery"></div>
        </section>
      </div>
    </main>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
      <button class="lightbox__close" type="button" aria-label="Close">✕ Close</button>
      <div class="lightbox__inner">
        <div class="lightbox__frame">
          <img id="lightbox-img" class="lightbox__img" alt="" />
          <div id="lightbox-caption" class="lightbox__caption"></div>
        </div>
      </div>
    </div>


    <script type="module" src="../js/posthog-init.js"></script>
    <script type="module">
  const galleryEl = document.getElementById('gallery');
  const lightboxEl = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const lightboxCaption = document.getElementById('lightbox-caption');
  const closeBtn = lightboxEl.querySelector('.lightbox__close');
  const itemById = new Map();
  let activeLightboxItem = null;

  const modalTriggers = document.querySelectorAll('[data-modal-trigger]');
  const infoModals = new Map(Array.from(document.querySelectorAll('.info-modal')).map((modal) => [modal.id, modal]));
  let activeInfoModal = null;

  function openInfoModal(id) {
    const modal = infoModals.get(id);
    if (!modal) return;
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    activeInfoModal = modal;
  }

  function closeActiveInfoModal() {
    if (!activeInfoModal) return false;
    activeInfoModal.classList.remove('open');
    activeInfoModal.setAttribute('aria-hidden', 'true');
    activeInfoModal = null;
    return true;
  }

  modalTriggers.forEach((trigger) => {
    const targetId = trigger.getAttribute('data-modal-trigger');
    trigger.addEventListener('click', () => openInfoModal(targetId));
  });

  infoModals.forEach((modal) => {
    modal.addEventListener('click', (event) => {
      if (event.target === modal) closeActiveInfoModal();
    });
    modal.querySelectorAll('[data-modal-close]').forEach((button) => button.addEventListener('click', closeActiveInfoModal));
  });

  function openLightbox(src, captionHtml) {
    if (!src) return;
    lightboxImg.style.opacity = 1;
    lightboxImg.src = src;
    lightboxCaption.innerHTML = captionHtml;
    lightboxEl.classList.add('open');
  }

  function closeLightbox() {
    lightboxEl.classList.remove('open');
    lightboxImg.src = '';
    lightboxCaption.textContent = '';
    activeLightboxItem = null;
  }

  closeBtn.addEventListener('click', closeLightbox);
  lightboxEl.addEventListener('click', (event) => {
    if (event.target === lightboxEl) closeLightbox();
  });
  window.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      if (closeActiveInfoModal()) return;
      closeLightbox();
    }
  });

  function applyImageSource(item, src, { blur }) {
    if (!src || !item.elements) return;
    for (const el of item.elements) {
      const current = el.getAttribute('src');
      const targetOpacity = blur ? 0.65 : 1;
      if (current !== src) {
        el.style.opacity = 0.25;
        el.setAttribute('src', src);
        requestAnimationFrame(() => {
          el.style.opacity = targetOpacity;
        });
      } else {
        el.style.opacity = targetOpacity;
      }
      if (blur) {
        el.classList.add('is-blur');
        el.classList.remove('is-sharp');
      } else {
        el.classList.remove('is-blur');
        el.classList.add('is-sharp');
      }
    }
  }

  function requestFullImage(item, onReady) {
    if (!item.fullUrl) return;
    if (item.fullLoaded) {
      if (onReady) onReady();
      return;
    }
    if (!item.fullCallbacks) item.fullCallbacks = [];
    if (onReady) item.fullCallbacks.push(onReady);
    if (item.fullLoading) return;
    item.fullLoading = true;
    const full = new Image();
    full.decoding = 'async';
    full.onload = () => {
      item.fullLoaded = true;
      item.fullLoading = false;
      if (item.fullCallbacks) {
        for (const cb of item.fullCallbacks) cb();
        item.fullCallbacks = [];
      }
    };
    full.onerror = () => {
      item.fullLoading = false;
      if (item.fullCallbacks) item.fullCallbacks = [];
    };
    full.src = item.fullUrl;
  }

  function prefetchFull(item) {
    requestFullImage(item);
  }

  const imageObserver = new IntersectionObserver((entries, observer) => {
    for (const entry of entries) {
      if (!entry.isIntersecting) continue;
      const img = entry.target;
      observer.unobserve(img);
      const item = itemById.get(img.dataset.itemId);
      if (!item) continue;

      if (!item.previewLoaded && !item.previewLoading && item.thumbUrl && item.thumbUrl !== item.fullUrl) {
        item.previewLoading = true;
        const preview = new Image();
        preview.decoding = 'async';
        preview.onload = () => {
          item.previewLoaded = true;
          item.previewLoading = false;
          applyImageSource(item, item.thumbUrl, { blur: false });
          prefetchFull(item);
        };
        preview.onerror = () => {
          item.previewLoading = false;
          item.previewLoaded = true;
          prefetchFull(item);
        };
        preview.src = item.thumbUrl;
      } else {
        if (item.thumbUrl && item.previewLoaded) {
          applyImageSource(item, item.thumbUrl, { blur: false });
        }
        prefetchFull(item);
      }
    }
  }, { rootMargin: '300px 0px' });

  function escapeHtml(value) {
    return String(value).replace(/[&<>"']/g, (char) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[char]);
  }

  function escapeAttr(value) {
    return String(value).replace(/"/g, '&quot;');
  }

  function formatAnimalName(value) {
    return String(value || '')
      .trim()
      .split(/(\s+)/)
      .map((segment) => {
        if (/\s+/.test(segment)) return segment;
        return segment.charAt(0).toUpperCase() + segment.slice(1);
      })
      .join('');
  }

  function setInitialImage(item, img) {
    if (!item.elements) {
      item.elements = new Set();
    }
    item.elements.add(img);

    if (item.previewLoaded && item.thumbUrl) {
      applyImageSource(item, item.thumbUrl, { blur: false });
    } else if (item.blurUrl) {
      applyImageSource(item, item.blurUrl, { blur: true });
    } else if (item.thumbUrl) {
      item.previewLoaded = true;
      applyImageSource(item, item.thumbUrl, { blur: false });
    } else if (item.fullUrl) {
      item.fullLoaded = true;
      applyImageSource(item, item.fullUrl, { blur: false });
    } else {
      img.src = '';
    }
  }

  function buildThumb(item, width, height) {
    const anchor = document.createElement('a');
    anchor.className = 'thumb';
    anchor.href = item.fullUrl || item.thumbUrl || '#';
    anchor.style.width = `${width}px`;
    anchor.style.height = `${height}px`;
    anchor.title = `${item.displayAnimal} — by ${item.artist}`;

    const img = document.createElement('img');
    img.loading = 'lazy';
    img.decoding = 'async';
    img.alt = `${item.displayAnimal} by ${item.artist}`;
    img.dataset.itemId = item.id;

    setInitialImage(item, img);

    const needsObserver = (
      (!item.previewLoaded && !item.previewLoading && !!item.thumbUrl && item.thumbUrl !== item.fullUrl) ||
      (!!item.fullUrl && !item.fullLoaded)
    );
    if (needsObserver) {
      imageObserver.observe(img);
    }

    anchor.appendChild(img);
    anchor.addEventListener('click', (event) => {
      event.preventDefault();
      const caption = `<span class="lightbox__title">${escapeHtml(item.displayAnimal)}</span><span class="lightbox__meta">by <a href="${escapeAttr(item.link)}" target="_blank" rel="noopener">${escapeHtml(item.artist)}</a></span>`;
      showItemInLightbox(item, caption);
    });

    return anchor;
  }

  function showItemInLightbox(item, captionHtml) {
    activeLightboxItem = item.id;
    const initialSrc = (item.fullLoaded && item.fullUrl) ? item.fullUrl : (item.thumbUrl || item.blurUrl || item.fullUrl);
    if (!initialSrc) return;
    openLightbox(initialSrc, captionHtml);
    if (item.fullUrl) {
      requestFullImage(item, () => {
        if (activeLightboxItem !== item.id) return;
        lightboxImg.style.opacity = 0.25;
        requestAnimationFrame(() => {
          lightboxImg.src = item.fullUrl;
          lightboxImg.style.opacity = 1;
        });
      });
    }
  }

  function createRow(items, targetHeight, containerWidth, gapPx) {
    const aspectSum = items.reduce((sum, item) => sum + (item.aspect || 1), 0);
    const totalGaps = gapPx * Math.max(items.length - 1, 0);
    const naturalHeight = (containerWidth - totalGaps) / Math.max(aspectSum, 0.0001);
    const rowHeight = Math.max(220, Math.min(640, naturalHeight));

    const rowEl = document.createElement('div');
    rowEl.className = 'gallery-row';

    for (const item of items) {
      const width = Math.max(180, Math.round(rowHeight * (item.aspect || 1)));
      const thumb = buildThumb(item, width, Math.round(rowHeight));
      rowEl.appendChild(thumb);
    }

    return { rowEl, rowHeight };
  }

  async function fetchConvexCollection() {
    const params = new URLSearchParams({
      perPage: '200',
      sort: '-created',
      fields: 'id,collectionId,animal,artist_name,link,full_img,preview_img,blur_img_load'
    });
    const response = await fetch(`/api/collections/collection/records?${params.toString()}`, { credentials: 'include' });
    if (!response.ok) throw new Error(`Convex fetch failed: ${response.status}`);
    const data = await response.json();
    const items = (data.items || []).map((record) => {
      const item = {
        id: record.id,
        collectionId: record.collectionId,
        animal: record.animal || '',
        artist: record.artist_name || '',
        displayAnimal: formatAnimalName(record.animal || ''),
        link: record.link || '#',
        fullUrl: record.full_img ? convexFileUrl(record, record.full_img) : '',
        thumbUrl: record.preview_img ? convexFileUrl(record, record.preview_img) : (record.full_img ? convexFileUrl(record, record.full_img) : ''),
        blurUrl: record.blur_img_load ? convexFileUrl(record, record.blur_img_load) : '',
        aspect: 1,
        previewLoaded: false,
        previewLoading: false,
        fullLoaded: false,
        fullLoading: false,
        fullCallbacks: [],
        elements: new Set()
      };
      itemById.set(item.id, item);
      return item;
    });
    return items;
  }

  function convexFileUrl(record, fileName) {
    const collection = record.collectionId || record.collection || 'collection';
    if (!fileName) return '';
    return `/api/files/${encodeURIComponent(collection)}/${encodeURIComponent(record.id)}/${encodeURIComponent(fileName)}`;
  }

  async function preloadDimensions(items) {
    const batchSize = 8;
    for (let start = 0; start < items.length; start += batchSize) {
      const batch = items.slice(start, start + batchSize);
      await Promise.all(batch.map((item) => new Promise((resolve) => {
        const source = item.fullUrl || item.thumbUrl || item.blurUrl;
        if (!source) {
          item.aspect = 1;
          resolve();
          return;
        }
        const img = new Image();
        img.onload = () => {
          const width = img.naturalWidth || 800;
          const height = img.naturalHeight || 600;
          item.aspect = width / height;
          resolve();
        };
        img.onerror = () => {
          item.aspect = 4 / 5;
          resolve();
        };
        img.src = source;
      })));
    }
  }

  function layout(items) {
    const containerWidth = Math.floor(galleryEl.clientWidth || galleryEl.offsetWidth || 0);
    if (!containerWidth) return;
    const targetHeight = 540;
    const gapPx = 16;

    imageObserver.disconnect();
    galleryEl.innerHTML = '';
    for (const item of items) {
      item.elements = new Set();
    }

    const workingRow = [];
    let aspectAccumulator = 0;

    for (const item of items) {
      workingRow.push(item);
      aspectAccumulator += (item.aspect || 1);
      const projectedWidth = aspectAccumulator * targetHeight + gapPx * (workingRow.length - 1);
      if (projectedWidth >= containerWidth && workingRow.length) {
        const { rowEl } = createRow(workingRow, targetHeight, containerWidth, gapPx);
        galleryEl.appendChild(rowEl);
        workingRow.length = 0;
        aspectAccumulator = 0;
      }
    }

    if (workingRow.length) {
      const { rowEl } = createRow(workingRow, targetHeight, containerWidth, gapPx);
      galleryEl.appendChild(rowEl);
    }
  }

  function setupResize(items) {
    let rafId = null;
    const onResize = () => {
      if (rafId) return;
      rafId = requestAnimationFrame(() => {
        rafId = null;
        layout(items);
      });
    };
    window.addEventListener('resize', onResize);
  }

  (async function init() {
    try {
      const items = await fetchConvexCollection();
      items.sort(() => Math.random() - 0.5);
      layout(items);
      await preloadDimensions(items);
      layout(items);
      setupResize(items);
    } catch (error) {
      console.error(error);
      galleryEl.textContent = 'Failed to load gallery.';
    }
  })();
</script>


  </body>
</html>
