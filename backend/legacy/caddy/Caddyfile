(site-common) {
    encode zstd gzip

    # Redirect legacy hype-picker path to mood-board
    handle_path /hype-picker/* {
        redir /mood-board{path} 302
    }

    # Unsplash direct proxy
    handle_path /api/unsplash/* {
        reverse_proxy https://api.unsplash.com {
            header_up Host api.unsplash.com
            header_up Authorization "Client-ID {$UNSPLASH_ACCESS_KEY}"
            header_up Accept "application/json"
            transport http {
                tls_server_name api.unsplash.com
            }
        }
    }

    # PocketBase admin UI
    handle /_/* {
        reverse_proxy 127.0.0.1:8090
    }

    # PocketBase API
    handle /api/* {
        reverse_proxy 127.0.0.1:8090 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Sprite path fix
    handle_path /pages/pixel-cat-maker/public/sprites/* {
        rewrite * /pixel-cat-maker/public/sprites{path}
        file_server
    }

    root * /srv/webpage-frontend
    file_server
}

:8000 {
    import site-common
}

:9090 {
    @root path /
    rewrite @root /stream.html

    import site-common
}
